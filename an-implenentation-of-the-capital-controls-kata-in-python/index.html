<!doctype html><html lang=en-au><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Michail Konst"><meta property="og:type" content="article"><meta property="og:image" content="https://www.michailkonst.com//img/home.jpg"><meta property="twitter:image" content="https://www.michailkonst.com//img/home.jpg"><meta name=title content="An Implenentation of the Capital Controls Kata in Python"><meta property="og:title" content="An Implenentation of the Capital Controls Kata in Python"><meta property="twitter:title" content="An Implenentation of the Capital Controls Kata in Python"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta property="og:url" content="https://www.michailkonst.com/an-implenentation-of-the-capital-controls-kata-in-python/"><meta property="twitter:card" content="A walkthrough of the Capital Controls Kata in Python. Train of thought and a retrospective."><meta name=keyword content><link rel="shortcut icon" href=/img/favicon.ico><title>An Implenentation of the Capital Controls Kata in Python | Michail Konst</title>
<link rel=canonical href=/an-implenentation-of-the-capital-controls-kata-in-python/><link rel=alternate type=application/rss+xml title="Michail Konst" href=/index.xml><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.min.css><link rel=stylesheet href=/css/font-awesome.all.min.css><link rel=stylesheet href=https://www.michailkonst.com/css/custom.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Michail Konst</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags></div><h1>An Implenentation of the Capital Controls Kata in Python</h1><h2 class=subheading></h2><span class=meta>Posted by
Michail Konst
on
Sunday, September 6, 2020</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>In a previous article, I presented the <a href=/blog/capital-controls-programming-kata/>Capital Controls Kata</a> and the intent to publish a walkthrough. Here it is.</p><h2 id=preparation>Preparation</h2><p>I used Visual Studio Code as my code editor and unittest as the Python test framework.</p><p>The entire code base is available on <a href=https://github.com/michailkonst/CapitalControlsKata/>Github</a>.</p><h2 id=basic-functionality>Basic functionality</h2><p>Before we dive into imposing capital controls on our banks, we need to have a set of functioning bank operations! So, here is an anonymous bank that performs the following:</p><ul><li>Cash deposits</li><li>Cash withdrawals</li><li>Domestic electronic transfers</li><li>Electronic transfers abroad</li></ul><p>Each operation should result in a success or fail and that should be communicated to the caller.</p><p>The bank should disallow overdrafts, i.e. attempts to withdraw or transfer more money that is in the account should result to an insufficient funds message.</p><p>There would be a domain with a Bank and an Account class. Doing Test-Driven Development or Test-First Development doesn&rsquo;t mean you don&rsquo;t have an architecture in mind, you&rsquo;re just not married to it.</p><p>Further, successful debits or credits would create a transaction object with a date and time. Unsuccessful attempts to debit or credit an account would not create a record of the operation, but only return an &ldquo;operation failed&rdquo; message to the caller. If there were a need to do include records of failed attempts to interact with an account as part of the basic functionality, we would revisit that as part of the restrictions imposition.</p><p>I made the operation of transfers abroad to act the same as a cash withdrawal - these operations have funds leave the domestic banking network and domestic banks lose track of those funds forever. Why have two different operations? At the time of coding the basic functionality I went really slowly and didn&rsquo;t yet know how to differentiate the operations (this isn&rsquo;t a real banking application where real money does get transferred out of a domestic bank and there is no database involved here either.)</p><h3 id=deposit-funds-to-an-account>Deposit funds to an account</h3><p>I started with the first test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BankTest</span>(unittest<span style=color:#f92672>.</span>TestCase):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_deposit_to_account</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> BankAccount()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>100</span>, account<span style=color:#f92672>.</span>balance)
</span></span></code></pre></div><p>Pretty straightforward, there is a bank and there is an account.
Defining the methods of the problem domain, I went on to implement the bank operation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Bank</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>deposit_to_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        account<span style=color:#f92672>.</span>_deposit(amount) 
</span></span></code></pre></div><p>And the account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>balance <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>balance <span style=color:#f92672>+=</span> amount
</span></span></code></pre></div><p>This was the third simplest thing that would make the test pass. Granted, you could have simply have the balance return a constant int of 100, triangulate with more test cases and arrive at the above code and that is, in fact, the approach I took in subsequent tests. An in-between approach would be to just assign the balance to the amount in the <code>_deposit</code> method. It&rsquo;s easy to get carried away and jump to the solution if you know what to implement. The point here is to not get too far without tests preceding your implementation and I tried to make myself cognizant of that during the process.</p><h3 id=withdrawal>Withdrawal</h3><p>Withdrawal came next:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>0</span>, account<span style=color:#f92672>.</span>balance)
</span></span></code></pre></div><p><code>Bank</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        account<span style=color:#f92672>.</span>_withdraw(amount) 
</span></span></code></pre></div><p><code>Account</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>balance <span style=color:#f92672>-=</span> amount
</span></span></code></pre></div><p>I went slowly, but not that slowly. Instead of returning a constant from the <code>_withdraw</code> method, I subtracted the amount. Again, I could have taken it a step back and triangulated with more test cases.</p><p>Account methods <code>_deposit</code> and <code>_withdraw</code> are marked internal (with the leading underscore) as these should only be accessed from the same library.</p><p>One could argue that the <code>Bank</code> class may be starting to suffer from <a href=https://refactoring.guru/smells/feature-envy>feature envy</a>. At the moment it does nothing of its own but uses methods from the <code>Account</code> class. However, there is a strong argument to be made about class responsibilities and encapsulation - the user only interacts through their account via the bank, never directly through the account. The bank is, if you like, the gatekeeper between the ustomer and the account. If it turned out at the end of the implementation that the <code>Bank</code> class is redundant, the code would be refactored so <code>Bank</code> could be removed. You could also start from the bottom up and not have a <code>Bank</code> class in the first place until you need it. Remember, this is &ldquo;Iteration 0&rdquo; of the problem where we do not have a concept of future requirements where restrictions on capital could be asked of the development team.</p><p>Withdrawing an overdraft will result in a negative balance. Let&rsquo;s fix that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_overdraft_doesnotallow</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>100</span>, account<span style=color:#f92672>.</span>balance)
</span></span></code></pre></div><p>Passing the test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (amount <span style=color:#f92672>&lt;=</span> self<span style=color:#f92672>.</span>balance):
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>balance <span style=color:#f92672>-=</span> amount
</span></span></code></pre></div><p>Both withdrawal tests are passing.</p><p>At this point, it&rsquo;s time to do some clean-up. Account.balance is a public and settable property. That is more than the current tests use. Also, it seems wrong that an external entity is able to manipulate something as important as an account&rsquo;s balance on a whim.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Balance</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__balance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>+=</span> amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (amount <span style=color:#f92672>&lt;=</span> self<span style=color:#f92672>.</span>__balance):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span></code></pre></div><p>We should also communicate the fact that a withdrawal operation (at first) may have failed due to insufficient funds. For that to happen, the <code>_withdraw</code> method can return an enum. I find this more intuitive than a boolean, even if we later on end up not expanding the scenarios for which a withdrawal may not happen.</p><p>Note that this time, in contrast with prevous examples, we are using parameterised tests to triangulate in order to arrive at the final algorithm in our production code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>400</span>,),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>600</span>,),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_overdraft_results_in_error</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>InsufficientFunds, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(account<span style=color:#f92672>.</span>Balance, <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><p>In the <code>Account</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>New enum in place.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OperationResult</span>(Enum):
</span></span><span style=display:flex><span>    Success <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    InsufficientFunds <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>The <code>Bank</code> class doesn&rsquo;t change.</p><p>So far, so good, but our basic functionality is very basic; there really needs to be a concept of a record that a transaction has taken place with every successful deposit, withdrawal and transfer.</p><h3 id=transaction>Transaction</h3><p>A transaction will have to be created with each deposit. That transaction should hold the date and time that it took place. The <code>Account</code> class should have a concept of transactions. Additionally, it seems wrong that an account can be initialised with a balance out of nowhere; every amount that is in the account should come in with a record of a transaction having taken place.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>300</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_deposit_to_account_creates_transaction</span>(self, amount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        operationResult <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>deposit_to_account(account, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, operationResult)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_first_transaction(account)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(TransactionType<span style=color:#f92672>.</span>Credit, transaction<span style=color:#f92672>.</span>Type)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_first_transaction</span>(self, account):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> transaction <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> transaction
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Transaction</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, type, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Amount <span style=color:#f92672>=</span> amount
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>():
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>+=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Credit, amount))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TransactionType</span>(Enum):
</span></span><span style=display:flex><span>    Credit <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Let&rsquo;s add more properties to the transaction object apart from just its type. We will need an amount and the date and time it took place.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>300</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_deposit_to_account_creates_transaction</span>(self, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        daatetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account(daatetimemock)
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        operationResult <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>deposit_to_account(account, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, operationResult)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_first_transaction(account)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(TransactionType<span style=color:#f92672>.</span>Credit, transaction<span style=color:#f92672>.</span>Type)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span></code></pre></div><p>Expanding the previous test, we&rsquo;re creating a mock that will give us a date and time we can assert to. We are also asserting an amount.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Transaction</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, type, amount, datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Amount <span style=color:#f92672>=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>DateTime <span style=color:#f92672>=</span> datetime
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, datetime <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>datetime <span style=color:#f92672>=</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>+=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Credit, amount, self<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()))
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span></code></pre></div><p>For withdrawals:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> <span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)        
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account(datetimemock)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span></code></pre></div><p>We want to assert there is a transaction for this withdrawal and it&rsquo;s been marked as a debit</p><p>Account class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, self<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>Transaction class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TransactionType</span>(Enum):
</span></span><span style=display:flex><span>    Credit <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    Debit <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>Any potential for refactoring? Sure there is.</p><ul><li>Passing the date/time onto a transaction shouldn&rsquo;t be a responsibility of the Account class, in my opinion, but that of the Bank class. The Bank is the &ldquo;driver&rdquo; behind these operations, the account is a &ldquo;receiver&rdquo;. This is also shown by the way the tests are structured. We ever test the <code>Account</code> class directly, we test it through the <code>Bank</code> class, which is the interface between the user and their accounts.</li><li>The <code>Transactions</code> can (and should) be encapsulated into a private member with a getter.</li><li>Same for the <code>Transaction</code> class&rsquo;s members.</li></ul><p>Let&rsquo;s begin.</p><h4 id=refactoring-1-moving-the-datetime-provider>Refactoring 1: Moving the date/time provider</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>300</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_deposit_to_account_creates_transaction</span>(self, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        operationResult <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>deposit_to_account(account, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, operationResult)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_first_transaction(account)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(TransactionType<span style=color:#f92672>.</span>Credit, transaction<span style=color:#f92672>.</span>Type)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)        
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Bank</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, datetimeprovider <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__datetimeprovider <span style=color:#f92672>=</span> datetimeprovider
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>deposit_to_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_deposit(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>():
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>balance</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__balance
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>+=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Credit, amount, datetime))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>Transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><h4 id=refactoring-2-transactions-in-account-made-private-with-a-getter>Refactoring 2: Transactions in Account made private with a getter</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>():
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Transactions</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__transactions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_deposit</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>+=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Credit, amount, datetime))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>
</span></span></code></pre></div><h4 id=refactoring-3-transaction-member-encapsulation>Refactoring 3: Transaction member encapsulation</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Transaction</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, type, amount, datetime):
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>__type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>__amount <span style=color:#f92672>=</span> amount
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>__dateTime <span style=color:#f92672>=</span> datetime
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Type</span>(self):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__type
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Amount</span>(self):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__amount
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>DateTime</span>(self):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__dateTime
</span></span></code></pre></div><h3 id=electronic-transfer-domestic>Electronic transfer (domestic)</h3><p>Next up is domestic electronic transfer of funds. The below test sets up balances on two accounts and then transfers funds from one to the other.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_eletronic_transfer</span>(self):
</span></span><span style=display:flex><span>        account_from <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        account_to <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account_from, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account_to, <span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer(account_from, account_to, <span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>50</span>, account_from<span style=color:#f92672>.</span>Balance)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>100</span>, account_to<span style=color:#f92672>.</span>Balance)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span></code></pre></div><p>If you have to explain a unit test it&rsquo;s probably a bad one.</p><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer</span>(self, account_from, account_to, amount):
</span></span><span style=display:flex><span>        date <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>        account_from<span style=color:#f92672>.</span>_withdraw(amount, date)
</span></span><span style=display:flex><span>        account_to<span style=color:#f92672>.</span>_deposit(amount, date)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>In this implementation, if a <code>account_to._deposit(amount, date)</code> operation fails for whatsoever reason, the funds would be lost from the <code>account_from</code> account. For the purposes of this exercise, we will not be dealing with the transactionality of operations.</p><p>It does pass the test but a transfer isn&rsquo;t really a cash withdrawal and a deposit. We will have to rethink this functionality. But first, let&rsquo;s implement the alectronic transfer abroad.</p><h3 id=eletronic-transfer-abroad>Eletronic transfer (abroad)</h3><p>We are starting with a test to update an account&rsquo;s balance. We also want to keep the API of the <code>Bank</code> and the <code>Account</code> consistent with the other operations, so we are returning an <code>OperationResult</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>200</span>, <span style=color:#ae81ff>100</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>300</span>, <span style=color:#ae81ff>100</span>),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_transfer_abroad_removes_from_balance</span>(self, initialbalance, withdrawalamount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, initialbalance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, withdrawalamount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(initialbalance <span style=color:#f92672>-</span> withdrawalamount, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p><code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_transfer_abroad(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p><code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_abroad</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>Next up is to guard against an insufficient balance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>400</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>600</span>,),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test__transfer_abroad_insufficient_sender_funds</span>(self, withdrawalamount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, withdrawalamount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>InsufficientFunds, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(account<span style=color:#f92672>.</span>Balance, <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><p><code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_abroad</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>And finally, the transaction:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test__transfer_abroad_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)        
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>transfer_abroad(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span></code></pre></div><p>In <code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_abroad</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><h4 id=marking-debit-types>Marking debit types</h4><p>As mentioned earlier, for the purposes of this exercise we will only be simulating the difference between the various ways an account can be debited. In this instance we can mark debit as such.
We have three types of debit, one is for cash withdrawals, one for domestic bank transfers and one for transfers abroad. Let&rsquo;s implement those.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)        
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(DebitType<span style=color:#f92672>.</span>CashWithdrawal, transaction<span style=color:#f92672>.</span>DebitType)
</span></span></code></pre></div><p>The last line will assert that with a cash withdrawal, the transaction that is created will be marked as a Cash Withdrawal one.</p><p>In <code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime, DebitType<span style=color:#f92672>.</span>CashWithdrawal))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>And in <code>Transaction</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Transaction</span>():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, type, amount, datetime, debitType <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__amount <span style=color:#f92672>=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__dateTime <span style=color:#f92672>=</span> datetime
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__debitType <span style=color:#f92672>=</span> debitType
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Type</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__type
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Amount</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>DateTime</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__dateTime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>DebitType</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__debitType
</span></span></code></pre></div><p>New enum, <code>DebitType</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DebitType</span>(Enum):
</span></span><span style=display:flex><span>    CashWithdrawal <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>We follow the same logic to mark domestic transfers and transfers abroad. I did remove the cash withdrawal and deposit logic previously used to simulate a bank transfer and now I have a different operation in place that creates a transaction marked as a <code>DomesticElectronicTransfer</code>. I didn&rsquo;t think that for this exercise we would need a way to distinguish between credit transactions so I didn&rsquo;t implement one. The funds in a domestic electroncic transfer are still credited to the beneficiary with the generic <code>Account._deposit</code> method.</p><p>If a transaction is a debit transaction (it&rsquo;s <code>TransactionType</code> property is <code>Debit</code>) then its <code>DebitType</code> property must not be <code>None</code>. This is not enforced by unit tests, this is an internal implementation of how <code>Account</code> creates transactions.</p><h2 id=restriction-1---ban-all-transfers-abroad-and-enforce-a-60-limit-on-daily-cash-withdrawals>Restriction 1 - ban all transfers abroad and enforce a $60 limit on daily cash withdrawals</h2><p>I must admit I only picked up steam once I reached that point. I thought this is going to be the real challenge of this exercise, how do we cleanly enforce restrictions in our bank operations?</p><p>As the business logic changes, the tests will change, so I started there. The assertions in place will only be valid if the withdrawal amount is $60 or less. Transfers abroad aren&rsquo;t allowed.</p><h3 id=transfers-abroad>Transfers Abroad</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_transfer_abroad_not_allowed</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span></code></pre></div><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span></code></pre></div><p>Simple as that. The account&rsquo;s functionality remains untouched. The &ldquo;guardian&rdquo; to the account, which is the bank, controls what kind of access is given to an account.</p><p>Here I&rsquo;ve introduced another named value in the <code>OperationResult</code> enum. <code>NotAllowed</code> means that although the funds are there to be debited from the account and the transfer can otherwise happen, there are restrictions in place that disallow this.</p><p>What&rsquo;s happened to the other Transfer Abroad tests we had? The test that assert insufficient funds is now failing</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>200</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>400</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>600</span>,),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test__transfer_abroad_insufficient_sender_funds</span>(self, withdrawalamount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, withdrawalamount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>InsufficientFunds, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(account<span style=color:#f92672>.</span>Balance, <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><p>Line <code>self.assertEqual(OperationResult.InsufficientFunds, result)</code> is now failing as the <code>OperationResult</code> we get back is <code>InsufficientFunds</code>. Also, this test case no longer applies as we simply disallow any and all transfers abroad. Therefore this and all other test that have driven the Transfer Abroad functionality except for the one we just added, no longer assert current business rules and are deleted.</p><h3 id=cash-withdrawals>Cash withdrawals</h3><p>New test with three test cases for triangulation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>61</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>62</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>70</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_of_over_60_dollars_not_allowed</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>100</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>This obviously fails until we implement the desired functionality</p><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (amount <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>60</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>Some test cases for <code>test_withdraw_removes_from_balance</code>,<code>test_withdraw_overdraft_results_in_error</code> and <code>test_withdraw_creates_transaction</code> are failing because thye are out of date so we update the test cases for the withdrawal amounts to conform to the new business rules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_removes_from_balance</span>(self, initialbalance, withdrawalamount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, initialbalance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawalamount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(initialbalance <span style=color:#f92672>-</span> withdrawalamount, account<span style=color:#f92672>.</span>Balance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>20</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>40</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>60</span>,),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_overdraft_results_in_error</span>(self, withdrawalamount):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawalamount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>InsufficientFunds, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(account<span style=color:#f92672>.</span>Balance, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>40</span>,),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DateTimeMock</span>(datetime<span style=color:#f92672>.</span>datetime):
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>now</span>(cls):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cls(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)        
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> DateTimeMock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span></code></pre></div><p>At this point I decided to swap the inner classes for mocking the date and time with Python&rsquo;s <code>unittest.mock</code> library to make tests more readable.</p><h3 id=more-than-one-cash-withdrawal-in-a-day>More than one cash withdrawal in a day</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_over_daily_amount_in_multiple_transactions_not_allowed_three_transactions</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>21</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>60</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit:
</span></span><span style=display:flex><span>                amount_already_drawn <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>Note the class variable <code>__max_daily_limit</code>. This is a constant set to 60. We have done away with the magic integer of 60 and have given it context.</p><p>This code will not renew the daily allowance of an account the next day. Let&rsquo;s write a test that asserts that we will be able to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_over_daily_amount_in_multiple_transactions_across_two_days_is_allowed</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>30</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>And in <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount_already_drawn <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>Here, we&rsquo;re checking what has already been withdrawn on the day before we decide if the operation is allowed.</p><p>Removing the first two lines of <code>withdraw_from_account</code> does not affect the tests, therefore the lines were redundant.</p><h2 id=restriction-2-roll-over-missed-cash-withdrawals-for-up-to-a-week>Restriction 2: Roll over missed cash withdrawals for up to a week.</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_if_monday_missed_withdraw_twice_as_much_on_tuesday</span>(self):
</span></span><span style=display:flex><span>account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>120</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>80</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>Small steps here. May 12, 2020 is a Tuesday and we want to take out Tuesday&rsquo;s allowance as well as Monday&rsquo;s.</p><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):           
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount_already_drawn <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>=</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date() <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                    money_drawn_previous_day <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> money_drawn_previous_day <span style=color:#f92672>+</span> diff <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>There&rsquo;s a lot going on here. Is there any clean up we can do?</p><p>For one thing, some of the account querying can be moved where it&rsquo;s better suited; the <code>Account</code> class.</p><p><code>Account</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_withdrawn_amount_on_date</span>(self, date):     
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):           
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>=</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date() <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                    money_drawn_previous_day <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> money_drawn_previous_day <span style=color:#f92672>+</span> diff <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed            
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>It&rsquo;s already starting to look better. Proceeding further:</p><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):           
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>=</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> money_drawn_previous_day <span style=color:#f92672>+</span> diff <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed            
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>The account has now the additional responsibility of querying its transactions to return the amount that was withdrawn on a day and the bank makes a query when it needs it.</p><p>Only we can do better still. Whether or not to allow a withdrawal can move to its own method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):       
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>__can_withdraw(account, amount):  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed            
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>=</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> money_drawn_previous_day <span style=color:#f92672>+</span> diff <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>That will any missed allowance to carry over by a day. What about the rest of the week?</p><p>Let&rsquo;s write a test to assert that on Saturday we will be able to withdraw any cash we didn&rsquo;t withdrawn since Monday.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span>(self):
</span></span><span style=display:flex><span>account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)<span style=color:#75715e># Tuesday</span>
</span></span><span style=display:flex><span>bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)<span style=color:#75715e># Saturday</span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>250</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>1690</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>Passing the test in <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit:
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>=</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__max_daily_limit
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>            money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> money_drawn_previous_day <span style=color:#f92672>+</span> diff <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>That will take us back five days to calculate withdrawn amounts. Philosophical analysis: this is <strong>any</strong> five days back, so if the current day was a Tuesday this implementation would calculate all withdrawn amounts back to Thursday next week so we&rsquo;re getting more functionality than the unit test requires. This all comes down to &ldquo;what is the smallest piece of code that will pass a test&rdquo;. The above segment will pass the test. Placing guard clauses to only stop at the Monday of the current week (and not cover potential cases not covered by the newest unit test) would require additional code, so I didn&rsquo;t do it as it seemed like I would overengineer the solution. However, there will be other unit tests that prevent the algorithm going back too far in the past.</p><p>After <code>test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</code>, passed, other tests failed. More specifically:</p><p><code>test_withdrawal_of_over_daily_limit_not_allowed</code>
<code>test_withdrawal_over_daily_limit_in_multiple_transactions_not_allowed_two_transactions</code>
<code>test_withdrawal_over_daily_limit_in_multiple_transactions_not_allowed_three_transactions</code></p><p>were failing as the implementaiton in <code>Bank</code> would go back five days in the past and wouldn&rsquo;t stop on Monday. These tests won&rsquo;t pass until we change the logic of the <code>Bank</code> class to stop on Monday of the current week and put new test cases on them.</p><p>Next up, we need to do something about this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>money_drawn_previous_day <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>money_drawn_previous_day <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>))
</span></span></code></pre></div><p>Sometimes you get to a point where writing a more generic algorithm may be simpler than passing this above case but you need to be careful how far away from your tests you&rsquo;re stepping. It seems like the time has come to implement the functionality to only go far back until the Monday for the current week.</p><p>Enriching a test in our test suite with test cases:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>250</span>, OperationResult<span style=color:#f92672>.</span>Success), <span style=color:#75715e>#first day: Monday, second day:Saturday</span>
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>360</span>, OperationResult<span style=color:#f92672>.</span>Success), <span style=color:#75715e>#first day: Tuesday, second day:Sunday</span>
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>361</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed), <span style=color:#75715e>#first day: Thursday, second day:Sunday</span>
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>61</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed), <span style=color:#75715e>#first day: Monday, second day:Tuesday</span>
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span>(self, day_of_month_first_trn, first_withdrawal_amount, day_of_month_second_trn, second_withdrawal_amount, operation_result):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, day_of_month_first_trn, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)  
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, first_withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, day_of_month_second_trn, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) 
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, second_withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(operation_result, result)
</span></span></code></pre></div><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>        amount_already_drawn <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(now)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount_already_drawn <span style=color:#f92672>+</span> amount <span style=color:#f92672>&gt;</span> Bank<span style=color:#f92672>.</span>__max_daily_limit: 
</span></span><span style=display:flex><span>            day_of_week_index <span style=color:#f92672>=</span> now<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>            money_withdrawn_this_week <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (day_of_week_index <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                    money_withdrawn_this_week <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(now <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i))
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> money_withdrawn_this_week <span style=color:#f92672>+</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>In Python, <code>datetime.weekday()</code> is a zero-based index of the day of the week, so it ranges from 0 (Monday) to 6 (Sunday). This passes the test but what can we do to make it better?</p><p>For one thing, removing line <code>amount_already_drawn = account._get_withdrawn_amount_on_date(now)</code> and the conditional <code>if amount_already_drawn + amount > Bank.__max_daily_limit:</code> will still pass the test and can be removed. One could argue that without the if clause, the method will enumerate cash withdrawals for the past few days even if withdrawal eligibility is ruled out from day one, but our aim here is maintainability before performance. We can make it fast later if we have to. For now, let&rsquo;s simplify our algorithm.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> now<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        money_withdrawn_this_week <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (day_of_week_index <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                money_withdrawn_this_week <span style=color:#f92672>+=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_on_date(now <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn_this_week <span style=color:#f92672>+</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)  
</span></span></code></pre></div><p>That&rsquo;s good, except we can do better. Calculation of the money withdrawn in the current week can be moved to <code>Account</code> as it&rsquo;s a query more appropriate for an account.</p><p><code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount): 
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> now<span style=color:#f92672>.</span>weekday()     
</span></span><span style=display:flex><span>        money_withdrawn_this_week <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_this_week_so_far_for_date(now)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn_this_week <span style=color:#f92672>+</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)    
</span></span></code></pre></div><p><code>Account</code> gets a new internal method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_withdrawn_amount_this_week_so_far_for_date</span>(self, date):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> date<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        money_withdrawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (day_of_week_index <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                money_withdrawn <span style=color:#f92672>+=</span> self<span style=color:#f92672>.</span>__get_withdrawn_amount_on_date(date <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn
</span></span></code></pre></div><p>and a new private method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_withdrawn_amount_on_date</span>(self, date):     
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><p>Test <code>test_withdrawal_if_monday_missed_withdraw_twice_as_much_on_tuesday</code> is now redundant and removed.</p><p>Test <code>test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</code> can have additional test cases to check what happens across weeks; if we attempt to draw out $121 on a Tuesday, that must be disallowed as up to $120 are permitted on any Tuesday.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span> <span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>181</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed), <span style=color:#75715e>#first day: Saturday, second day: Wednesday next week</span>
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span>(self, day_of_month_first_trn, first_withdrawal_amount, day_of_month_second_trn, second_withdrawal_amount, operation_result):
</span></span></code></pre></div><p>That passes without more production code, which means our previous implementation also covers that case.</p><p>Structure so far: account has methods to get money drawn out this day (private) and week (internal)</p><h2 id=restriction-3-trasfers-abroad-are-permitted-for-up-to-500>Restriction 3: Trasfers abroad are permitted for up to $500</h2><p>In this iteration we allow transfers abroad again but there is an upper limit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>489</span>, OperationResult<span style=color:#f92672>.</span>Success),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>499</span>, OperationResult<span style=color:#f92672>.</span>Success),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>500</span>, OperationResult<span style=color:#f92672>.</span>Success),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>500.50</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>501</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>502</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed)
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_transfer_abroad_up_to_weekly_limit_500</span>(self, amount, operation_result):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(operation_result, result)
</span></span></code></pre></div><p>which leads us to this implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>500</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_transfer_abroad(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span></code></pre></div><p>with a bit of refactoring to give context to a &ldquo;magic&rdquo; number:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>__max_weekly_bank_transfer_abroad_limit <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_weekly_bank_transfer_abroad_limit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_transfer_abroad(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span></code></pre></div><h3 id=mark-electronic-transfers>Mark electronic transfers</h3><p>At this time there is no way of knowing whether a transaction is a transfer abroad one. We need to mark this. That could have been done as part of the basic functionality, but we can always apply it to new transactions going forward as it will be adequate to implement this new waiving of restrictions. We&rsquo;re doing this for domestic transfers too.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DebitType</span>(Enum):
</span></span><span style=display:flex><span>    CashWithdrawal <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    ElectronicTransferDomestic <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    ElectronicTransferAbroad <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>50</span>,),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>,),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test__transfer_abroad_creates_transaction</span>(self, withdrawal_amount):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>transfer_abroad(account, withdrawal_amount)
</span></span><span style=display:flex><span>        transaction <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__get_transaction(account, <span style=color:#66d9ef>lambda</span> t: t<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertNotEqual(<span style=color:#66d9ef>None</span>, transaction)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_amount, transaction<span style=color:#f92672>.</span>Amount)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>0</span>), transaction<span style=color:#f92672>.</span>DateTime)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(DebitType<span style=color:#f92672>.</span>ElectronicTransferAbroad, transaction<span style=color:#f92672>.</span>DebitType)
</span></span></code></pre></div><p>And in <code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_domestic</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime, DebitType<span style=color:#f92672>.</span>ElectronicTransferDomestic))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_abroad</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime, DebitType<span style=color:#f92672>.</span>ElectronicTransferAbroad))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><h3 id=multiple-electronic-transfers-abroad-to-reach-or-surpass-weekly-limit>Multiple electronic transfers abroad to reach or surpass weekly limit</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span> <span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>250</span>, <span style=color:#ae81ff>250</span>, OperationResult<span style=color:#f92672>.</span>Success), 
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>100</span>, OperationResult<span style=color:#f92672>.</span>Success), 
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>250</span>, <span style=color:#ae81ff>251</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>499</span>, <span style=color:#ae81ff>2</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed)
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_transfer_abroad_up_to_weekly_limit_two_transactions</span>(self, first_withdrawal_amount, second_withdrawal_amount, second_trn_operation_result):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account()
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)     
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>transfer_abroad(account, first_withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, second_withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(second_trn_operation_result, result)
</span></span></code></pre></div><p>A parameterised unit test like this will allow us to go past the initial implementation which would allow transfers abroad over the weekly limit if multiple of those were had.</p><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>__can_transfer_abroad(account, amount):  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_transfer_abroad(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_transfer_abroad</span>(self, account, amount): 
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() 
</span></span><span style=display:flex><span>        money_withdrawn_this_week <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_this_week_so_far_for_date(now)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn_this_week <span style=color:#f92672>+</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_weekly_bank_transfer_abroad_limit   
</span></span></code></pre></div><h3 id=testing-cash-withdrawals-first-and-transfers-abroad-second>Testing cash withdrawals (first) and transfers abroad (second)</h3><p>This is going to be interesting to see because in the <code>__can_transfer_abroad</code> method of the <code>Bank</code> class, before the decision whether to allow a transfer abroad is made, we&rsquo;re checking the total amount that has been debited this week including cash withdrawals, not just transfers abroad. <code>Account._get_withdrawn_amount_this_week_so_far_for_date</code> will return a greater amount if also cash withdrawals were made during the week and legitimate below-limit amounts to be transferred abroad won&rsquo;t check out. Let&rsquo;s distinguish the two types of debit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_withdraw_to_limit_and_transfer_abroad_to_limit_in_same_week</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)     
</span></span><span style=display:flex><span>        result_withdraw <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>420</span>)
</span></span><span style=display:flex><span>        result_transfer_abroad <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result_withdraw)        
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result_transfer_abroad)
</span></span></code></pre></div><p>It was a bad idea to not mock the date here. I wrote this test on a Sunday. The next day this test failed when asserting that the cash withdrawal is successful. Why? (Hint: it&rsquo;s in the business rules).</p><p>In the <code>Bank</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_transfer_abroad</span>(self, account, amount): 
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now() 
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        money_transfered_abroad_this_week <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_amount_transfered_abroad_this_week_so_far_for_date(now)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_transfered_abroad_this_week <span style=color:#f92672>+</span> amount <span style=color:#f92672>&lt;=</span> Bank<span style=color:#f92672>.</span>__max_weekly_bank_transfer_abroad_limit 
</span></span></code></pre></div><p><code>Bank</code> is using the yet-unwritten <code>Account</code>&rsquo;s method to get all the money that&rsquo;s been transferred abroad this week.</p><p><code>Account</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_amount_transfered_abroad_this_week_so_far_for_date</span>(self, date):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> date<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        money_withdrawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (day_of_week_index <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                money_withdrawn <span style=color:#f92672>+=</span> self<span style=color:#f92672>.</span>_get_amount_transfered_abroad_for_date(date <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_amount_transfered_abroad_for_date</span>(self, date):
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>                <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DebitType <span style=color:#f92672>==</span> DebitType<span style=color:#f92672>.</span>ElectronicTransferAbroad \
</span></span><span style=display:flex><span>                <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><h3 id=testing-transfers-abroad-second-and-cash-withdrawals-first>Testing transfers abroad (second) and cash withdrawals (first)</h3><p>Now, we&rsquo;ll transfer money abroad and then withdraw cash. Bear in mind that <code>Account</code>&rsquo;s <code>__get_withdrawn_amount_on_date</code> still looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_withdrawn_amount_on_date</span>(self, date):     
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Debit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():            
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><p>The amount for all debits on a given date will be returned.</p><p>Starting with a test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_transfer_abroad_to_limit_and_withdraw_to_limit_and_in_same_week</span>(self):
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank()
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)    
</span></span><span style=display:flex><span>        result_transfer_abroad <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>500</span>) 
</span></span><span style=display:flex><span>        result_withdraw <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>420</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result_transfer_abroad)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result_withdraw)        
</span></span></code></pre></div><p>To pass this, we revisit <code>__get_withdrawn_amount_on_date</code> to add the cash withdrawal restriction</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_withdrawn_amount_on_date</span>(self, date):     
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>DebitType <span style=color:#f92672>==</span> DebitType<span style=color:#f92672>.</span>CashWithdrawal \
</span></span><span style=display:flex><span>                <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><p>It&rsquo;s time for some refactoring.</p><h3 id=refactor-1-factor-out-debit-transaction-queries>Refactor 1: Factor out debit transaction queries</h3><p>There are two private methods in <code>Account</code> that largely do the same thing; one gets the total amount withdrawn as cash on a date and the other gets the total amount transfered abroad. We can extract a common method for the two.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_withdrawn_amount_this_week_so_far_for_date</span>(self, date):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_get_debited_amount_this_week_so_far_for_date(date, DebitType<span style=color:#f92672>.</span>CashWithdrawal)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_amount_transfered_abroad_this_week_so_far_for_date</span>(self, date):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_get_debited_amount_this_week_so_far_for_date(date, DebitType<span style=color:#f92672>.</span>ElectronicTransferAbroad)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_debited_amount_this_week_so_far_for_date</span>(self, date, debit_type):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> date<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        money_withdrawn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (day_of_week_index <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                money_withdrawn <span style=color:#f92672>+=</span> self<span style=color:#f92672>.</span>__get_debited_amount_on_date(date <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i), debit_type)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_withdrawn    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get_debited_amount_on_date</span>(self, date, debit_type):     
</span></span><span style=display:flex><span>        amount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>                <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DebitType <span style=color:#f92672>==</span> debit_type \
</span></span><span style=display:flex><span>                <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                amount <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount
</span></span></code></pre></div><p>No tests are failing.</p><h3 id=refactor-2-factor-out-debit-transaction-operations>Refactor 2: Factor out debit transaction operations</h3><p>Withdrawing and transfering are very similar in our example. All that is changing is the marking of a transaction with a <code>DebitType</code> enum value.</p><p><code>Account</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_withdraw</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__debit(amount, datetime, DebitType<span style=color:#f92672>.</span>CashWithdrawal)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_domestic</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__debit(amount, datetime, DebitType<span style=color:#f92672>.</span>ElectronicTransferDomestic)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_transfer_abroad</span>(self, amount, datetime):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__debit(amount, datetime, DebitType<span style=color:#f92672>.</span>ElectronicTransferAbroad)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__debit</span>(self, amount, datetime, debit_type):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>&lt;</span> amount):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>InsufficientFunds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__balance <span style=color:#f92672>-=</span> amount
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__transactions<span style=color:#f92672>.</span>add(Transaction(TransactionType<span style=color:#f92672>.</span>Debit, amount, datetime, debit_type))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>Success
</span></span></code></pre></div><p>Tests are passing</p><h2 id=restriction-4-new-deposits-are-exempt-from-withdrawal-restrictions>Restriction 4: New deposits are exempt from withdrawal restrictions</h2><p>Here we can either mark new deposits as &ldquo;fresh&rdquo; or query the account with every attempt to withdrawal/transfer to check if enough funds were deposited after a certain &ldquo;restrictions ease&rdquo; date to qualify. Both methods have the pros and cons. The first option is good for performance at withdrawals. The second option keeps the theoretical backend database (or several databases) free of changes. Given that capital controls are (hopefully) temporary, we don&rsquo;t want to be in a situation where we&rsquo;re changing a database (or several) and then reverting and retesting once the restrictions are over, so we&rsquo;re going with option 2.</p><p>Let&rsquo;s start with our test. The date we are selecting for this capital control relaxation is Monday 18/05/2020.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_new_deposits_are_exempt_from_withdrawal_restrictions</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)      
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e>## Monday</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>        result_withdraw <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result_withdraw)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>0</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>Implementation in <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>__can_withdraw(account, amount):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>__is_fresh_deposit(account, amount):  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed            
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__is_fresh_deposit</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> account<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Credit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime <span style=color:#f92672>==</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                total_deposits_after_cutoff_date <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>==</span> total_deposits_after_cutoff_date
</span></span></code></pre></div><p>This passes the test. Let&rsquo;s refactor. The query in <code>__is_fresh_deposit</code> can be move to <code>Account</code> in the same fashion as previous queries.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_total_amount_for_credits</span>(self, date):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Credit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>==</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                total_deposits_after_cutoff_date <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> total_deposits_after_cutoff_date
</span></span></code></pre></div><p><code>Bank</code> becomes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__is_fresh_deposit</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits(datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>==</span> total_deposits_after_cutoff_date
</span></span></code></pre></div><p>The relaxation date stays with the bank, the rule-setter.</p><p>We should also do away with the &ldquo;magic&rdquo; date in <code>__is_fresh_deposit</code> and move it to a class variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>__start_date_for_fresh_transactions <span style=color:#f92672>=</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__is_fresh_deposit</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits(__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>==</span> total_deposits_after_cutoff_date
</span></span></code></pre></div><p>We should also be able to &ldquo;dig&rdquo; into our previous savings that had been there before 18/05/2020 after exhausting any funds deposited to the account after that date.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>260</span>, OperationResult<span style=color:#f92672>.</span>Success), <span style=color:#75715e># Monday, Day restrictions are eased for new deposits</span>
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>320</span>, OperationResult<span style=color:#f92672>.</span>Success),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>321</span>, OperationResult<span style=color:#f92672>.</span>NotAllowed)
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_can_withdraw_daily_amount_with_rollover_plus_deposits_after_20200518</span>(self, day_of_month_to_withdraw, withdrawal_amount, withdrawal_result):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)      
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># Day before restrictions are eased for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>120</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, day_of_month_to_withdraw, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) 
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(withdrawal_result, result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> withdrawal_result<span style=color:#f92672>==</span>OperationResult<span style=color:#f92672>.</span>Success:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>320</span> <span style=color:#f92672>-</span> withdrawal_amount, account<span style=color:#f92672>.</span>Balance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>320</span>, account<span style=color:#f92672>.</span>Balance )
</span></span></code></pre></div><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>withdraw_from_account</span>(self, account, amount):       
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>__can_withdraw(account, amount) <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>__can_withdraw_with_fresh_deposit(account, amount):  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_withdraw(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw_with_fresh_deposit</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits_on_and_after_date(Bank<span style=color:#f92672>.</span>__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>&lt;=</span> total_deposits_after_cutoff_date <span style=color:#f92672>+</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>-</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_this_week_so_far_for_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span></code></pre></div><p>In <code>Account</code>, <code>_get_total_amount_for_credits</code> is renamed and modified.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_total_amount_for_credits_on_and_after_date</span>(self, date):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trn <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>Transactions:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> trn<span style=color:#f92672>.</span>Type <span style=color:#f92672>==</span> TransactionType<span style=color:#f92672>.</span>Credit <span style=color:#f92672>and</span> trn<span style=color:#f92672>.</span>DateTime<span style=color:#f92672>.</span>date() <span style=color:#f92672>&gt;=</span> date<span style=color:#f92672>.</span>date():
</span></span><span style=display:flex><span>                total_deposits_after_cutoff_date <span style=color:#f92672>+=</span> trn<span style=color:#f92672>.</span>Amount        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> total_deposits_after_cutoff_date
</span></span></code></pre></div><p>Let&rsquo;s assert that transfers abroad behave the same, with their own weekly $500 limit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_can_transfer_abroad_above_weekly_limit_with_deposits_after_20200518</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)      
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># Day before restrictions are eased for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) 
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>0</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>__can_transfer_abroad(account, amount) <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>__can_transfer_abroad_with_fresh_deposit(account, amount):  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> account<span style=color:#f92672>.</span>_transfer_abroad(amount, self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResult<span style=color:#f92672>.</span>NotAllowed
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_transfer_abroad_with_fresh_deposit</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits_on_and_after_date(Bank<span style=color:#f92672>.</span>__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        money_transfered_abroad_this_week <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_amount_transfered_abroad_this_week_so_far_for_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>==</span> Bank<span style=color:#f92672>.</span>__max_weekly_bank_transfer_abroad_limit <span style=color:#f92672>+</span> total_deposits_after_cutoff_date <span style=color:#f92672>-</span> money_transfered_abroad_this_week
</span></span></code></pre></div><h3 id=cleanup>Cleanup</h3><p>The OR conditional in the <code>transfer_abroad</code> method is in place in order to make sure existing, up-to-date tests aren&rsquo;t broken when adding new rules. However, the bodies of <code>__can_transfer_abroad</code> and <code>__can_transfer_abroad_with_fresh_deposit</code> look a lot alike and it turns out that <code>__can_transfer_abroad</code> is a redundant check that can be removed without failing the tests. <code>__can_transfer_abroad_with_fresh_deposit</code> covers both &ldquo;fresh&rdquo; deposits as well as older ones. The same is true of the <code>withdraw_from_account</code>, so the extra check there is removed.</p><h3 id=asserting-interwowen-cash-withdrawals-and-transfer-abroad-transactions>Asserting interwowen cash withdrawals and transfer abroad transactions</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_can_withdraw_and_transfer_abroad_daily_amount_with_rollover_plus_deposits_after_20200518</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)  
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># Day before restrictions are eased for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>120</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) 
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>100</span>)        
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>1920</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>0</span>, account<span style=color:#f92672>.</span>Balance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_can_withdraw_and_transfer_abroad_daily_amount_with_rollover_plus_deposits_after_20200518_over_limit_not_allowed</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)  
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># Day before restrictions are eased for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) 
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>200</span>)       
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>transfer_abroad(account, <span style=color:#ae81ff>1400</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>2800</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>Before the first deposit, we always set the date to a date earlier than 18/05/2020 so the money debited are subject to restrictions</p><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits_on_and_after_date(Bank<span style=color:#f92672>.</span>__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>        money_withdrawn_this_week_so_far_for_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_this_week_so_far_for_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>&lt;=</span> total_deposits_after_cutoff_date <span style=color:#f92672>+</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> money_withdrawn_this_week_so_far_for_date
</span></span></code></pre></div><p><code>Account</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_debited_amount_this_week_so_far_for_date</span>(self, date, debit_type):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> date<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        money_debited <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>            money_debited <span style=color:#f92672>+=</span> self<span style=color:#f92672>.</span>__get_debited_amount_on_date(date <span style=color:#f92672>-</span> timedelta(days <span style=color:#f92672>=</span> i), debit_type)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> money_debited
</span></span></code></pre></div><p>And with yet another method extraction in <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_withdraw</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits_on_and_after_date(Bank<span style=color:#f92672>.</span>__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>        money_withdrawn_this_week_so_far_for_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_withdrawn_amount_this_week_so_far_for_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>&lt;=</span> total_deposits_after_cutoff_date <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>__calculate_max_withdrawal_limit_on_current_day_of_week() <span style=color:#f92672>-</span> money_withdrawn_this_week_so_far_for_date
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__calculate_max_withdrawal_limit_on_current_day_of_week</span>(self):
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__can_transfer_abroad</span>(self, account, amount):
</span></span><span style=display:flex><span>        total_deposits_after_cutoff_date <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_total_amount_for_credits_on_and_after_date(Bank<span style=color:#f92672>.</span>__start_date_for_fresh_transactions)
</span></span><span style=display:flex><span>        money_transfered_abroad_this_week <span style=color:#f92672>=</span> account<span style=color:#f92672>.</span>_get_amount_transfered_abroad_this_week_so_far_for_date(self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> amount <span style=color:#f92672>&lt;=</span> total_deposits_after_cutoff_date <span style=color:#f92672>+</span> Bank<span style=color:#f92672>.</span>__max_weekly_bank_transfer_abroad_limit <span style=color:#f92672>-</span> money_transfered_abroad_this_week
</span></span></code></pre></div><h2 id=restriction-5-extend-time-limit-to-two-weeks>Restriction 5: extend time limit to two weeks</h2><p>We&rsquo;ll start with cash withdrawals. As each week starts on Monday, we&rsquo;ll set a Monday to act as the starting day the two weeks will start from, and will be renewed two Mondays later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_missed_daily_cash_withdrawals_can_be_backed_up_for_two_weeks</span>(self):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)  
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># This is a date before restrictions are eased (18-5-2020) for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, <span style=color:#ae81ff>840</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>Success, result)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(<span style=color:#ae81ff>1160</span>, account<span style=color:#f92672>.</span>Balance)
</span></span></code></pre></div><p>Again, we deposit some money before the date Iteration 4 takes effect so they are subject to the capital control restrictions as the rules don&rsquo;t apply to any money deposited afterwards. Then, at a date in the future, we withdraw $840. We pick 1-Jun-2020 as the date Iteraion 5 takes effect.</p><p>In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__calculate_max_withdrawal_limit_on_current_day_of_week</span>(self):  
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span>  self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (now <span style=color:#f92672>&gt;=</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>date()):
</span></span><span style=display:flex><span>            day_of_week_index2 <span style=color:#f92672>=</span> (now <span style=color:#f92672>-</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>date())<span style=color:#f92672>.</span>days
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        day_of_week_index <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> (day_of_week_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>A bit crude, for now, but the test has become green. Expectedly, some tests have failed after changing the above method. These pertain to cash withdrawals (as this is what we&rsquo;ve just changed now) and the maximum withdrawal amount that spanned across a week but it now spans across two.</p><p>Our next step is to assert that additional funds cannot be withdrawn until the two-week period has elapsed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>900</span>),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>900</span>),
</span></span><span style=display:flex><span>        (<span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>121</span>),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</span>(self, day, withdrawal_amount):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)  
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># This is a date before restrictions are eased (18-5-2020) for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, day, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># 20 days after 1-6-2020, when missed cash allowance started rolling over in the space of two weeks</span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span></code></pre></div><p>That&rsquo;s failing, so we&rsquo;re adding this to <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__calculate_max_withdrawal_limit_on_current_day_of_week</span>(self):  
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span>  self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        day_of_week_index_two_weeks <span style=color:#f92672>=</span> (now <span style=color:#f92672>-</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>date())<span style=color:#f92672>.</span>days <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> day_of_week_index_two_weeks <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>14</span>:
</span></span><span style=display:flex><span>            day_of_week_index_two_weeks <span style=color:#f92672>=</span> day_of_week_index_two_weeks <span style=color:#f92672>-</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> day_of_week_index_two_weeks
</span></span></code></pre></div><p>This will make test cases for <code>test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</code> pass provided these do not exceed 28 days after 1/6/2020. So, let&rsquo;s add test cases for July and fail them!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#a6e22e>@parameterized.expand</span>([
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>900</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>900</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>121</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>121</span>),
</span></span><span style=display:flex><span>       (<span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>241</span>),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</span>(self, day, month, withdrawal_amount):
</span></span><span style=display:flex><span>        datetimemock <span style=color:#f92672>=</span> Mock()        
</span></span><span style=display:flex><span>        account <span style=color:#f92672>=</span> Account() 
</span></span><span style=display:flex><span>        bank <span style=color:#f92672>=</span> Bank(datetimemock)  
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># This is a date before restrictions are eased (18-5-2020) for new deposits</span>
</span></span><span style=display:flex><span>        bank<span style=color:#f92672>.</span>deposit_to_account(account, <span style=color:#ae81ff>2000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        datetimemock<span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2020</span>, month, day, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) <span style=color:#75715e># 20 days after 1-6-2020, when missed cash allowance started rolling over in the space of two weeks</span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> bank<span style=color:#f92672>.</span>withdraw_from_account(account, withdrawal_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertEqual(OperationResult<span style=color:#f92672>.</span>NotAllowed, result)
</span></span></code></pre></div><p>You see where this is going. We need to think in terms of 14-day intervals.</p><p><code>Bank</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__calculate_max_withdrawal_limit_on_current_day_of_week</span>(self):  
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span>  self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        day_of_week_index_two_weeks <span style=color:#f92672>=</span> ((now <span style=color:#f92672>-</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>date())<span style=color:#f92672>.</span>days <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> day_of_week_index_two_weeks <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            day_of_week_index_two_weeks <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> day_of_week_index_two_weeks
</span></span></code></pre></div><p>A little refactoring is in order. In <code>Bank</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>
</span></span><span style=display:flex><span>__start_of_two_week_periods <span style=color:#f92672>=</span> datetime(<span style=color:#ae81ff>2020</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>date()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__calculate_max_withdrawal_limit_on_current_day_of_week</span>(self):  
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span>  self<span style=color:#f92672>.</span>__datetimeprovider<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>date()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        day_of_week_index_two_weeks <span style=color:#f92672>=</span> ((now <span style=color:#f92672>-</span> Bank<span style=color:#f92672>.</span>__start_of_two_week_periods)<span style=color:#f92672>.</span>days <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>        day_of_week_index_two_weeks <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__adjust_for_end_of_two_week_period(day_of_week_index_two_weeks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bank<span style=color:#f92672>.</span>__max_daily_limit <span style=color:#f92672>*</span> day_of_week_index_two_weeks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__adjust_for_end_of_two_week_period</span>(self, day_of_week_index_two_weeks):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>14</span> <span style=color:#66d9ef>if</span> day_of_week_index_two_weeks <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>else</span> day_of_week_index_two_weeks
</span></span></code></pre></div><p>There are more tests failing still. That is happening because restrictions are now reset every other week instead of every week and the withdrawal amount has proportionately increased. We need to go through all the failing tests one-by-one and adjust them. I started with the smaller ones, such as <code>test_withdraw_creates_transaction</code> and proceeded to the longer ones. Tests are updated with new dates post 1-6-2020 as the release will happen after a specific date and the rules will be referencing that specific date. Edge cases which previously failed are also updated with appropriate dates and amounts. We&rsquo;re not losing generality, just like we didn&rsquo;t lose generality implementing Iteration 4 as the releases would take place on the dates that are referenced in <code>Bank</code> as class variables.</p><h2 id=final-thoughts>Final Thoughts</h2><p>As mentioned I didn&rsquo;t initially have a mock to generate dates at will, because <a href=https://martinfowler.com/bliki/Yagni.html>YAGNI</a>, yet I didn&rsquo;t want to reference a <code>datetime</code> straight from the <code>Bank</code> class but wanted to have it as a constructor dependency in order for the <code>Bank</code> class to advertise the fact that it needs a <code>datetime</code> object.</p><p>As I was changing the implementation code, existing tests acted as a safeguard that ensured that unrelated functionality didn&rsquo;t break. This is one of the benefits of having unit tests and a good coverage apart from all the other benefits, such as not overengineering your implementation and reducing regressions.</p><p>If requirements changed in a future iteration, there was a time I would go back to existing unit tests and change the assertions and/or parameters that went into the &ldquo;Act&rdquo; phase of the test, then pass that change test in the production code. That would work for me if the unit tests were fewer than they are in this instance. If there are heaps of unit tests, these days I write a new test, pass it and, in case any old tests are broken, understand why and fix them (or fix the production code, or both). It could be that they are failing because they&rsquo;ve become outdated with the changing of the requirements and some may even need to be removed. Any such possibilities are spotted at once once you&rsquo;ve implemented a change and tests start to fail.</p><p>One way to manage releases which are date-dependant as Iterations 4 and 5 in this exercise is to release ahead of time instead of the midnight of the day past the deadline and have two branches of logic depending on what date it is. This implementation assumes that production systems are shut down for maintenance on the midnight past the deadline and the new code is deployed during that window. It&rsquo;s all about what approach you;d like to take.</p><hr><ul class=pager><li class=previous><a href=/tab-out-validate-dropdowns-knockoutjs/ data-toggle=tooltip data-placement=top title="Trigger validation of a dropdown box when tabbing over it in KnockoutJS">&larr;
Previous Post</a></li><li class=next><a href=/newrelic-agent-apline-docker-container/ data-toggle=tooltip data-placement=top title="Installing the NewRelic .NET agent on an Alpine Docker image">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>Contents</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=https://x.com/michailkonst><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/michailkonst><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/michailkonstant/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Michail Konst 2025</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){n=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),t=$(this).text(),i=$('<a href="'+o+'" rel="nofollow" title="'+t+'">'+t+"</a>"),s=$('<li class="'+n+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>